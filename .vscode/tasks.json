{
    "version": "2.0.0",
    "tasks": [
        {
            "label": "compile",
            "identifier": "compile",
            "type": "shell",
            "command": "arm-none-eabi-g++",
            "args": [
                // --- FLAGS
                "-mcpu=cortex-m3",
                "-mthumb",
                "-Wall",
                "-ffunction-sections",
                "-fno-exceptions",      // if use exceptions - produse error: undefined reference to `_exit'; undefined reference to `_kill'; undefined reference to `_getpid'
                "-g",
                "-O0",
                "-c",
                // --- DEFINES
                "-DSTM32F103C8",
                "-DSTM32F10X_MD",
                "-DUSE_STDPERIPH_DRIVER",
                "-D__ASSEMBLY__",
                "-DSUPPORT_CPLUSPLUS",
                // --- INCLUDES
                // Libs
                "-I${workspaceRoot}/libs/cmsis/CM3/CoreSupport",
                "-I${workspaceRoot}/libs/cmsis/CM3/DeviceSupport/ST/STM32F10x",
                "-I${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/inc",
                // User
                "-I${workspaceRoot}/source/main/headers",
                "-I${workspaceRoot}/source/drivers/headers",
                "-I${workspaceRoot}/source/utils/headers",
                "-I${workspaceRoot}/source/tests/realHardware/headers",
                // --- SOURCES
                // Libs
                "${workspaceRoot}/source/main/modules/startup_stm32f10x_md.S",      // ASM startup init
                //"${workspaceRoot}/source/main/modules/startup_stm32f10x_md.c",    // ANSI C startup init
                "${workspaceRoot}/libs/cmsis/CM3/DeviceSupport/ST/STM32F10x/system_stm32f10x.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/misc.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_rcc.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_gpio.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_usart.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_i2c.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_rtc.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_pwr.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_dma.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_adc.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_tim.c",
                "${workspaceRoot}/libs/STM32F10x_StdPeriph_Driver/src/stm32f10x_flash.c",
                // User
                "${workspaceRoot}/source/drivers/modules/delay.cpp",
                "${workspaceRoot}/source/drivers/modules/sysClock.c",
                "${workspaceRoot}/source/drivers/modules/gpio.c",
                "${workspaceRoot}/source/drivers/modules/led.cpp",
                "${workspaceRoot}/source/drivers/modules/usart.cpp",
                "${workspaceRoot}/source/drivers/modules/oneWire.cpp",
                "${workspaceRoot}/source/drivers/modules/oneWireSearch.cpp",
                "${workspaceRoot}/source/drivers/modules/ds18b20.cpp",
                "${workspaceRoot}/source/drivers/modules/i2c.cpp",
                "${workspaceRoot}/source/drivers/modules/lcd.cpp",
                "${workspaceRoot}/source/drivers/modules/rtc.cpp",
                "${workspaceRoot}/source/drivers/modules/adc.cpp",
                "${workspaceRoot}/source/drivers/modules/tacho.cpp",
                "${workspaceRoot}/source/drivers/modules/storage.cpp",
                "${workspaceRoot}/source/drivers/modules/intTempSensor.cpp",
                "${workspaceRoot}/source/utils/modules/convertation.cpp",
                "${workspaceRoot}/source/utils/modules/crc.cpp",
                "${workspaceRoot}/source/utils/modules/strings.cpp",
                "${workspaceRoot}/source/utils/modules/oStream.cpp",                
                "${workspaceRoot}/source/tests/realHardware/testsApi.cpp",
                "${workspaceRoot}/source/main/modules/main.cpp"
            ],
            "problemMatcher": [
                "$msCompile"
            ]
        },
        {
            "dependsOn": "compile",
            "label": "link",
            "identifier": "link",
            "type": "shell",
            "command": "arm-none-eabi-g++",
            "args": [
                "-mcpu=cortex-m3",
                "-mthumb",
                "-g",
                //"--specs=nosys.specs",  // no semi-hosting which produses - libg.a(lib_a-exit.o): In function `exit': exit.c:(.text.exit+0x16): undefined reference to `_exit'
                "-nostartfiles",  // no standart libs! kills last error - libg.a(lib_a-exit.o): In function `exit': exit.c:(.text.exit+0x16): undefined reference to `_exit'
                "-Wl,-Map=${workspaceRoot}/bin/app.map",
                "-O0",
                "-Wl,--gc-sections",
                "-Wl,-T${workspaceRoot}/linkScripts/link.ld",
                "-g",
                "-o",
                "${workspaceRoot}/bin/app.elf",
                "${workspaceRoot}/misc.o",
                "${workspaceRoot}/startup_stm32f10x_md.o",
                "${workspaceRoot}/system_stm32f10x.o",
                "${workspaceRoot}/stm32f10x_rcc.o",
                "${workspaceRoot}/stm32f10x_gpio.o",
                "${workspaceRoot}/stm32f10x_usart.o",
                "${workspaceRoot}/stm32f10x_i2c.o",
                "${workspaceRoot}/stm32f10x_rtc.o",
                "${workspaceRoot}/stm32f10x_pwr.o",
                "${workspaceRoot}/stm32f10x_dma.o",
                "${workspaceRoot}/stm32f10x_adc.o",
                "${workspaceRoot}/stm32f10x_tim.o",
                "${workspaceRoot}/stm32f10x_flash.o",
                "${workspaceRoot}/delay.o",
                "${workspaceRoot}/sysClock.o",
                "${workspaceRoot}/gpio.o",
                "${workspaceRoot}/led.o",
                "${workspaceRoot}/usart.o",
                "${workspaceRoot}/oneWire.o",
                "${workspaceRoot}/oneWireSearch.o",
                "${workspaceRoot}/ds18b20.o",
                "${workspaceRoot}/i2c.o",
                "${workspaceRoot}/lcd.o",
                "${workspaceRoot}/rtc.o",
                "${workspaceRoot}/adc.o",
                "${workspaceRoot}/tacho.o",
                "${workspaceRoot}/storage.o",
                "${workspaceRoot}/intTempSensor.o",                
                "${workspaceRoot}/convertation.o",
                "${workspaceRoot}/crc.o",
                "${workspaceRoot}/strings.o",
                "${workspaceRoot}/oStream.o",
                "${workspaceRoot}/testsApi.o",
                "${workspaceRoot}/main.o"
            ],
            "problemMatcher": [
                "$msCompile"
            ]
        },
        {
            "dependsOn": "link",
            "label": "del",
            "identifier": "del",
            "type": "shell",
            "command": "DEL",
            "args": [
                "*.o"
            ],
            "problemMatcher": []
        },
        {
            "dependsOn": "del",
            "label": "bin",
            "identifier": "bin",
            "type": "shell",
            "command": "arm-none-eabi-objcopy",
            "args": [
                "-O",
                "binary",
                "${workspaceRoot}/bin/app.elf",
                "${workspaceRoot}/bin/app.bin"
            ],
            "problemMatcher": []
        },
        {
            "dependsOn": "bin",
            "label": "hex",
            "identifier": "hex",
            "type": "shell",
            "command": "arm-none-eabi-objcopy",
            "args": [
                "-O",
                "ihex",
                "${workspaceRoot}/bin/app.elf",
                "${workspaceRoot}/bin/app.hex"
            ],
            "problemMatcher": []
        },
        {
            "dependsOn": "hex",
            "label": "nm",
            "identifier": "nm",
            "type": "shell",
            "command": "arm-none-eabi-nm",
            "args": [
                "-n",
                "${workspaceRoot}/bin/app.elf",
                ">",
                "${workspaceRoot}/bin/app.sym"
            ],
            "problemMatcher": []
        },
        {
            "dependsOn": "nm",
            "label": "build",
            "identifier": "build",
            "type": "shell",
            "command": "arm-none-eabi-size",
            "args": [
                "${workspaceRoot}/bin/app.elf"
            ],
            "problemMatcher": [],
            "group": {
                "kind": "build",
                "isDefault": true
            }
        },
        {
            "label": "clean",
            "identifier": "clean",
            "type": "shell",
            "command": "DEL",
            "args": [
                "${workspaceRoot}\\bin\\ /q *.*"
            ],
            "problemMatcher": []
        },
        // --- UNIT TESTS BUILDING
        {
            "label": "buildTests",
            "type": "shell",
            "command": "g++",
            "args": [
                "-isystem",
                "../googleTest/googletest/include",
                "-pthread",
                // --- INCLUDES
                "-I${workspaceRoot}/source/utils/headers",
                // TestCases
                "${workspaceRoot}/source/tests/unit/unitTest.cpp",                
                // Tested modules
                "${workspaceRoot}/source/utils/modules/convertation.cpp",
                "${workspaceRoot}/source/utils/modules/crc.cpp",
                // TestFramework lib
                "../googleTest/googletest/build/gtest_main.a",                
                // output
                "-o",
                "${workspaceRoot}/bin/UnitTests",
                // compliler flags
                "-Wall",
                "-std=c++17"
            ]
        },
        {
            "label": "runTests",
            "dependsOn": "buildTests",
            "type": "shell",
            "command": "${workspaceRoot}/bin/UnitTests",
            "group": {
                "kind": "test",
                "isDefault": true
            }
        }
    ]
}


